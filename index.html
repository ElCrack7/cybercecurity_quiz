<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Quiz z cyberbezpiecze≈Ñstwa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1b2b;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      width: 100%;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .card {
      background: #15263a;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 4px;
      font-weight: bold;
    }

    select, button, input[type="checkbox"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      margin-bottom: 10px;
    }

    button {
      background: #1e90ff;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .answers {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }

    .answer-btn {
      text-align: left;
      background: #1d3552;
    }

    .answer-btn.correct {
      background: #2c7a3f;
    }

    .answer-btn.wrong {
      background: #b22222;
    }

    .hidden {
      display: none;
    }

    .score-timer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-weight: bold;
      font-size: 14px;
    }

    .score-box {
      font-weight: bold;
    }

    .timer {
      font-weight: bold;
    }

    .tag {
      display: inline-block;
      background: #233752;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 5px;
    }

    .explanation {
      margin-top: 10px;
      font-size: 14px;
      background: #101c2b;
      padding: 10px;
      border-radius: 8px;
      white-space: pre-line;
    }

    .reward {
      font-size: 18px;
      margin-top: 10px;
    }

    .small {
      font-size: 12px;
      opacity: 0.8;
    }

    .progress-bar {
      margin-top: 12px;
      background: #0e1a29;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #1e90ff, #00c896);
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-top: 4px;
      font-size: 12px;
      text-align: right;
      opacity: 0.8;
    }

    .police-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 10px;
      background: linear-gradient(135deg, #0f2545, #163b70);
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    .police-header-text {
      display: flex;
      flex-direction: column;
    }

    .police-header-title {
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .police-header-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }

    .police-icon {
      width: 42px;
      height: 42px;
      flex-shrink: 0;
    }

    .police-tape {
      margin-top: 10px;
      padding: 6px 10px;
      border-radius: 8px;
      background-image: repeating-linear-gradient(
        -45deg,
        #ffd600,
        #ffd600 10px,
        #001c40 10px,
        #001c40 20px
      );
      color: #001c40;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      text-align: center;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .badge {
      background: #233752;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
<div class="container">

  <!-- NAG≈Å√ìWEK POLICYJNY -->
  <div class="police-header">
    <svg class="police-icon" viewBox="0 0 64 64">
      <defs>
        <linearGradient id="shieldGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#2f5daa"/>
          <stop offset="100%" stop-color="#182c54"/>
        </linearGradient>
      </defs>
      <path d="M32 4
               C26 10,18 11,12 11
               C12 38,21 50,32 60
               C43 50,52 38,52 11
               C46 11,38 10,32 4Z"
            fill="url(#shieldGradient)" stroke="#d7e6ff" stroke-width="2"/>
      <polygon points="32,16 35,24 44,24 36.5,29.5 39.5,38 32,32.5 24.5,38 27.5,29.5 20,24 29,24"
               fill="#ffd600" stroke="#f3f3f3" stroke-width="1"/>
    </svg>

    <div class="police-header-text">
      <div class="police-header-title">Misja: CyberBezpiecze≈Ñstwo</div>
      <div class="police-header-subtitle">Modu≈Ç profilaktyczny ‚Äì wersja demonstracyjna</div>
    </div>
  </div>

  <h1>Quiz z cyberbezpiecze≈Ñstwa</h1>

  <!-- Panel startowy -->
  <div class="card" id="start-screen">
    <p>Wybierz poziom trudno≈õci i rozpocznij misjƒô bezpiecze≈Ñstwa w sieci üíªüõ°Ô∏è</p>

    <label for="difficulty">Poziom trudno≈õci:</label>
    <select id="difficulty">
      <option value="latwy">≈Åatwy</option>
      <option value="sredni">≈öredni</option>
      <option value="trudny">Trudny</option>
      <option value="mix">MIX (r√≥≈ºne poziomy)</option>
    </select>

    <label for="question-count">Liczba pyta≈Ñ w jednej rozgrywce:</label>
    <select id="question-count">
      <option value="5">5</option>
      <option value="10" selected>10</option>
    </select>

    <label>
      <input type="checkbox" id="presentation-mode">
      Tryb prezentacji (bez punkt√≥w i bez limitu czasu ‚Äì do pracy z grupƒÖ)
    </label>

    <p class="small">
      Pytania sƒÖ wczytywane z arkusza Google (CSV), kt√≥ry mo≈ºna ≈Çatwo aktualizowaƒá bez znajomo≈õci programowania.
    </p>

    <button id="start-btn" disabled>Start gry</button>
    <p id="load-status" class="small"></p>

      </div>

  <!-- Panel pytania -->
  <div class="card hidden" id="quiz-screen">
    <div id="question-header">
      <span class="tag" id="question-number-tag"></span>
      <span class="tag" id="difficulty-tag"></span>
    </div>
    <h2 id="question-text"></h2>

    <div class="answers" id="answers-container"></div>

    <div id="explanation" class="explanation hidden"></div>

    <div class="score-timer-row">
      <div class="score-box" id="score-box">
        Wynik: <span id="score">0</span> pkt
      </div>
      <div class="timer" id="timer">
        Czas: --
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-inner" id="progress-inner"></div>
    </div>
    <div class="progress-text" id="progress-text"></div>

    <button id="next-btn" class="hidden">Nastƒôpne pytanie</button>
  </div>

  <!-- Panel ko≈Ñcowy -->
  <div class="card hidden" id="end-screen">
    <h2>Koniec gry</h2>
    <p>Tw√≥j wynik: <span id="final-score"></span> punkt√≥w.</p>
    <p id="reward-text" class="reward"></p>
    <div id="badges"></div>
    <button id="restart-btn">Zagraj ponownie</button>
  </div>
</div>

<!-- D≈πWIƒòKI -->
<audio id="sound-correct" src="correct.wav"></audio>
<audio id="sound-wrong" src="wrong.wav"></audio>
<audio id="sound-next" src="next.wav"></audio>

<script>
  // üîó 1) TU WKLEJ LINK DO CSV Z GOOGLE SHEETS
  // Przyk≈Çad:
  // const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/ID/export?format=csv&gid=0";
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1v9U-jsyK9kfX7Pwo7TTtG8-LoJ3f40XbFE081mGwY0c/export?format=csv&gid=0";

  const startScreen = document.getElementById('start-screen');
  const quizScreen = document.getElementById('quiz-screen');
  const endScreen = document.getElementById('end-screen');

  const startBtn = document.getElementById('start-btn');
  const nextBtn = document.getElementById('next-btn');
  const restartBtn = document.getElementById('restart-btn');

  const difficultySelect = document.getElementById('difficulty');
  const questionCountSelect = document.getElementById('question-count');
  const presentationModeCheckbox = document.getElementById('presentation-mode');

  const questionNumberTag = document.getElementById('question-number-tag');
  const difficultyTag = document.getElementById('difficulty-tag');
  const questionText = document.getElementById('question-text');
  const answersContainer = document.getElementById('answers-container');
  const explanationBox = document.getElementById('explanation');
  const scoreBox = document.getElementById('score-box');
  const scoreSpan = document.getElementById('score');
  const finalScoreSpan = document.getElementById('final-score');
  const rewardText = document.getElementById('reward-text');
  const loadStatus = document.getElementById('load-status');
  const timerElement = document.getElementById('timer');
  const progressInner = document.getElementById('progress-inner');
  const progressText = document.getElementById('progress-text');
  const badgesContainer = document.getElementById('badges');

  const correctSound = document.getElementById("sound-correct");
  const wrongSound = document.getElementById("sound-wrong");
  const nextSound = document.getElementById("sound-next");

  let allQuestions = [];
  let currentQuestions = [];
  let currentIndex = 0;
  let score = 0;
  let answered = false;

  let presentationMode = false;
  let correctCount = 0;
  let totalAnswered = 0;

  let timePerQuestion = 20; // sekundy
  let timeLeft = 0;
  let timerInterval = null;

  // üîç Lepszy parser CSV ‚Äì obs≈Çuguje cudzys≈Çowy i przecinki w ≈õrodku p√≥l
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let value = "";
    let insideQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];

      if (insideQuotes) {
        if (c === '"') {
          if (text[i + 1] === '"') {
            value += '"';
            i++;
          } else {
            insideQuotes = false;
          }
        } else {
          value += c;
        }
      } else {
        if (c === '"') {
          insideQuotes = true;
        } else if (c === ',') {
          row.push(value);
          value = "";
        } else if (c === '\n' || c === '\r') {
          if (c === '\r' && text[i + 1] === '\n') {
            i++;
          }
          row.push(value);
          value = "";
          if (row.length > 1 || row[0] !== "") {
            rows.push(row);
          }
          row = [];
        } else {
          value += c;
        }
      }
    }

    if (value !== "" || row.length > 0) {
      row.push(value);
      rows.push(row);
    }

    if (rows.length < 2) return [];

    const header = rows[0].map(h => h.trim());
    const dataRows = rows.slice(1);

    const getIndex = (name) => header.indexOf(name);

    const idxId = getIndex('id');
    const idxCategory = getIndex('category');
    const idxDifficulty = getIndex('difficulty');
    const idxQuestion = getIndex('question');
    const idxAns1 = getIndex('ans1');
    const idxAns2 = getIndex('ans2');
    const idxAns3 = getIndex('ans3');
    const idxAns4 = getIndex('ans4');
    const idxCorrect = getIndex('correctIndex');
    const idxExplanation = getIndex('explanation');

    return dataRows.map(colsRaw => {
      const cols = colsRaw.map(c => (c || "").trim());
      return {
        id: idxId >= 0 ? Number(cols[idxId]) : null,
        category: idxCategory >= 0 ? cols[idxCategory] : "",
        difficulty: idxDifficulty >= 0 ? cols[idxDifficulty] : "",
        question: idxQuestion >= 0 ? cols[idxQuestion] : "",
        answers: [
          idxAns1 >= 0 ? cols[idxAns1] : "",
          idxAns2 >= 0 ? cols[idxAns2] : "",
          idxAns3 >= 0 ? cols[idxAns3] : "",
          idxAns4 >= 0 ? cols[idxAns4] : ""
        ],
        correctIndex: idxCorrect >= 0 ? Number(cols[idxCorrect]) : 0,
        explanation: idxExplanation >= 0 ? cols[idxExplanation] : ""
      };
    });
  }

  // üåê Wczytanie pyta≈Ñ z Google Sheets (CSV)
  async function loadQuestions() {
    loadStatus.textContent = "≈Åadowanie pyta≈Ñ z arkusza...";
    startBtn.disabled = true;

    try {
      if (!SHEET_CSV_URL || SHEET_CSV_URL.includes("WSTAW_TUTAJ")) {
        throw new Error("Nie ustawiono adresu SHEET_CSV_URL w kodzie.");
      }

      const response = await fetch(SHEET_CSV_URL);
      if (!response.ok) {
        loadStatus.textContent = `B≈ÇƒÖd HTTP ${response.status} ‚Äì sprawd≈∫ link i uprawnienia arkusza.`;
        return;
      }

      const csvText = await response.text();
      const parsed = parseCSV(csvText);
      allQuestions = parsed.filter(q => q.category === "cyber");

      if (allQuestions.length === 0) {
        loadStatus.textContent = "Brak pyta≈Ñ w kategorii 'cyber' w arkuszu.";
        return;
      }

      loadStatus.textContent = `Za≈Çadowano ${allQuestions.length} pyta≈Ñ z arkusza. Mo≈ºesz rozpoczƒÖƒá grƒô.`;
      startBtn.disabled = false;
    } catch (error) {
      console.error("B≈ÇƒÖd podczas fetch:", error);
      loadStatus.textContent = `Techniczny b≈ÇƒÖd: ${error.message}`;
      startBtn.disabled = true;
    }
  }

  function difficultyLabel(diff) {
    switch (diff) {
      case 'latwy': return '≈Åatwy';
      case 'sredni': return '≈öredni';
      case 'trudny': return 'Trudny';
      default: return diff;
    }
  }

  function difficultyPoints(diff) {
    switch (diff) {
      case 'latwy': return 1;
      case 'sredni': return 2;
      case 'trudny': return 3;
      default: return 1;
    }
  }

  function shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function updateProgressBar() {
    const total = currentQuestions.length || 1;
    const current = currentIndex + 1;
    const percent = Math.round((current / total) * 100);
    progressInner.style.width = percent + "%";
    progressText.textContent = `Postƒôp: ${current} / ${total} (${percent}%)`;
  }

  function resetTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    timeLeft = 0;
    if (!presentationMode) {
      timerElement.textContent = "Czas: --";
    } else {
      timerElement.textContent = "Tryb prezentacji";
    }
  }

  function startTimer() {
    if (presentationMode) {
      timerElement.textContent = "Tryb prezentacji";
      return;
    }
    clearInterval(timerInterval);
    timeLeft = timePerQuestion;
    timerElement.textContent = `Czas: ${timeLeft}s`;
    timerInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        timerElement.textContent = "Czas minƒÖ≈Ç";
        handleTimeUp();
      } else {
        timerElement.textContent = `Czas: ${timeLeft}s`;
      }
    }, 1000);
  }

  // ‚ñ∂Ô∏è Start gry
  function startGame() {
    const difficulty = difficultySelect.value;
    const questionCount = parseInt(questionCountSelect.value, 10);

    presentationMode = presentationModeCheckbox.checked;

    let filtered = [];
    if (difficulty === 'mix') {
      filtered = allQuestions;
    } else {
      filtered = allQuestions.filter(q => q.difficulty === difficulty);
    }

    if (filtered.length === 0) {
      alert('Brak pyta≈Ñ dla wybranego poziomu trudno≈õci w arkuszu. Dodaj je w Google Sheets.');
      return;
    }

    currentQuestions = shuffle(filtered).slice(0, questionCount);
    currentIndex = 0;
    score = 0;
    correctCount = 0;
    totalAnswered = 0;
    scoreSpan.textContent = score;

    if (presentationMode) {
      scoreBox.textContent = "Tryb prezentacji ‚Äì bez punkt√≥w";
    } else {
      scoreBox.innerHTML = 'Wynik: <span id="score-inner">' + score + '</span> pkt';
      // zaktualizuj referencjƒô do scoreSpan wewnƒÖtrz
      const inner = document.getElementById('score-inner');
      if (inner) {
        scoreSpan.textContent = score;
      }
    }

    resetTimer();

    startScreen.classList.add('hidden');
    endScreen.classList.add('hidden');
    quizScreen.classList.remove('hidden');

    showQuestion();
  }

  // ‚ùì Wy≈õwietlanie pytania
  function showQuestion() {
    answered = false;
    explanationBox.classList.add('hidden');
    explanationBox.textContent = '';
    nextBtn.classList.add('hidden');

    const q = currentQuestions[currentIndex];
    questionNumberTag.textContent = `Pytanie ${currentIndex + 1} / ${currentQuestions.length}`;
    difficultyTag.textContent = `Poziom: ${difficultyLabel(q.difficulty)}`;
    questionText.textContent = q.question;

    answersContainer.innerHTML = '';
    q.answers.forEach((answerText, index) => {
      const btn = document.createElement('button');
      btn.classList.add('answer-btn');
      btn.textContent = answerText;
      btn.addEventListener('click', () => handleAnswerClick(index));
      answersContainer.appendChild(btn);
    });

    updateProgressBar();
    resetTimer();
    startTimer();
  }

  function handleTimeUp() {
    if (answered) return;
    answered = true;

    const q = currentQuestions[currentIndex];
    const buttons = Array.from(document.getElementsByClassName('answer-btn'));

    buttons.forEach((btn, index) => {
      btn.disabled = true;
      if (index === q.correctIndex) {
        btn.classList.add('correct');
      }
    });

    explanationBox.textContent =
      `‚è∞ Czas minƒÖ≈Ç. Prawid≈Çowa odpowied≈∫: "${q.answers[q.correctIndex]}".\n` +
      (q.explanation || '');
    explanationBox.classList.remove('hidden');
    nextBtn.classList.remove('hidden');
  }

  // ‚úÖ/‚ùå Obs≈Çuga odpowiedzi
  function handleAnswerClick(selectedIndex) {
    if (answered) return;
    answered = true;
    clearInterval(timerInterval);

    const q = currentQuestions[currentIndex];
    const buttons = Array.from(document.getElementsByClassName('answer-btn'));

    buttons.forEach((btn, index) => {
      btn.disabled = true;
      if (index === q.correctIndex) {
        btn.classList.add('correct');
      }
      if (index === selectedIndex && index !== q.correctIndex) {
        btn.classList.add('wrong');
      }
    });

    if (!presentationMode) {
      totalAnswered++;
    }

    if (selectedIndex === q.correctIndex) {
      if (!presentationMode) {
        const pts = difficultyPoints(q.difficulty);
        score += pts;
        scoreSpan.textContent = score;
        correctCount++;
      }
      if (!presentationMode) {
        correctSound.currentTime = 0;
        correctSound.play();
      }
      explanationBox.textContent = `‚úÖ Dobrze!\n${q.explanation || ''}`;
    } else {
      if (!presentationMode) {
        wrongSound.currentTime = 0;
        wrongSound.play();
      }
      explanationBox.textContent =
        `‚ùå Niepoprawnie. Prawid≈Çowa odpowied≈∫: "${q.answers[q.correctIndex]}".\n` +
        (q.explanation || '');
    }

    explanationBox.classList.remove('hidden');
    nextBtn.classList.remove('hidden');
  }

  // üèÅ Koniec gry
  function endGame() {
    clearInterval(timerInterval);
    quizScreen.classList.add('hidden');
    endScreen.classList.remove('hidden');

    finalScoreSpan.textContent = score;

    badgesContainer.innerHTML = "";

    if (presentationMode || totalAnswered === 0) {
      rewardText.textContent = "üé§ Tryb prezentacji ‚Äì bez punktacji i odznak.";
      badgesContainer.textContent = "";
      return;
    }

    const maxPossible = currentQuestions.reduce((sum, q) => sum + difficultyPoints(q.difficulty), 0);
    const ratio = score / maxPossible;
    const correctRatio = correctCount / totalAnswered;

    if (ratio >= 0.8) {
      rewardText.textContent = "üéñ Poziom: Cyber Stra≈ºnik ‚Äì ≈õwietna znajomo≈õƒá zasad bezpiecze≈Ñstwa!";
    } else if (ratio >= 0.5) {
      rewardText.textContent = "üèÖ Poziom: Cyber Patrol ‚Äì jest dobrze, ale mo≈ºesz jeszcze poprawiƒá swoje zabezpieczenia.";
    } else {
      rewardText.textContent = "üîç Poziom: Cyber Rekrut ‚Äì potrzebujesz wiƒôcej treningu, ale to dobry poczƒÖtek.";
    }

    const badges = [];

    if (correctRatio === 1) {
      badges.push({ icon: "ü•á", text: "Perfekcyjny wynik" });
    } else if (correctRatio >= 0.8) {
      badges.push({ icon: "ü•à", text: "Bardzo dobra skuteczno≈õƒá odpowiedzi" });
    }

    const hasHard = currentQuestions.some(q => q.difficulty === "trudny");
    if (hasHard && correctRatio >= 0.6) {
      badges.push({ icon: "üõ°", text: "Pogromca trudnych pyta≈Ñ" });
    }

    if (totalAnswered >= 10) {
      badges.push({ icon: "üìö", text: "Wytrwa≈Çy uczestnik" });
    }

    if (badges.length > 0) {
      badgesContainer.className = "badges";
      badges.forEach(b => {
        const div = document.createElement("div");
        div.classList.add("badge");
        div.textContent = `${b.icon} ${b.text}`;
        badgesContainer.appendChild(div);
      });
    } else {
      badgesContainer.textContent = "Brak szczeg√≥lnych odznak ‚Äì spr√≥buj jeszcze raz, aby zdobyƒá wiƒôcej wyr√≥≈ºnie≈Ñ.";
    }
  }

  // üß∑ Obs≈Çuga przycisk√≥w
  startBtn.addEventListener('click', startGame);

  nextBtn.addEventListener('click', () => {
    nextSound.currentTime = 0;
    nextSound.play();
    currentIndex++;
    if (currentIndex >= currentQuestions.length) {
      endGame();
    } else {
      showQuestion();
    }
  });

  restartBtn.addEventListener('click', () => {
    endScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');
  });

  // üöÄ Na start: wczytaj pytania z arkusza
  loadQuestions();
</script>
</body>
</html>
